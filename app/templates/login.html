<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - MORGANXMYSTIC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto:wght@300;400;700&display=swap');
        body { font-family: 'Roboto', sans-serif; background-color: #111827; }
        .brand-font { font-family: 'Orbitron', sans-serif; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen text-gray-200">

    <div class="w-full max-w-md p-8 bg-gray-800 rounded-2xl shadow-2xl border border-gray-700">
        
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold tracking-widest text-white flex justify-center items-center">
                <span>MORGAN</span>
                <span class="text-4xl text-red-600 mx-1 brand-font">X</span>
                <span>MYSTIC</span>
            </h1>
            <p class="text-gray-500 text-xs mt-2 uppercase tracking-widest">Secure Cloud Storage</p>
        </div>

        <div id="step-phone">
            <p class="text-sm text-gray-400 mb-4 text-center">Sign in with your Telegram Phone Number</p>
            <form id="form-phone" onsubmit="handlePhoneSubmit(event)">
                <div class="relative mb-6">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-phone text-gray-500"></i>
                    </div>
                    <input type="text" name="phone" id="phoneInput" placeholder="+919999988888" class="w-full bg-gray-900 border border-gray-600 rounded-lg py-3 pl-10 text-white focus:outline-none focus:border-red-500 focus:ring-1 focus:ring-red-500 transition" required>
                </div>
                <button type="submit" id="btn-phone" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition transform hover:scale-[1.02] shadow-lg">
                    Send Code <i class="fas fa-paper-plane ml-2"></i>
                </button>
            </form>
        </div>

        <div id="step-code" class="hidden">
            <p class="text-sm text-gray-400 mb-4 text-center">Enter the code sent to your Telegram App</p>
            <form id="form-code" onsubmit="handleCodeSubmit(event)">
                <div class="relative mb-6">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-shield-alt text-gray-500"></i>
                    </div>
                    <input type="text" name="code" id="codeInput" placeholder="12345" class="w-full bg-gray-900 border border-gray-600 rounded-lg py-3 pl-10 text-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition text-center tracking-widest font-mono text-xl" required>
                </div>
                <button type="submit" id="btn-code" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition transform hover:scale-[1.02] shadow-lg">
                    Verify Code <i class="fas fa-check-circle ml-2"></i>
                </button>
            </form>
        </div>

        <div id="step-password" class="hidden">
            <p class="text-sm text-gray-400 mb-4 text-center">Enter your Two-Step Verification Password</p>
            <form id="form-password" onsubmit="handlePasswordSubmit(event)">
                <div class="relative mb-6">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-lock text-gray-500"></i>
                    </div>
                    <input type="password" name="password" id="passwordInput" placeholder="Password" class="w-full bg-gray-900 border border-gray-600 rounded-lg py-3 pl-10 text-white focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition" required>
                </div>
                <button type="submit" id="btn-password" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-lg transition transform hover:scale-[1.02] shadow-lg">
                    Unlock <i class="fas fa-unlock ml-2"></i>
                </button>
            </form>
        </div>

        <div id="statusMessage" class="mt-4 text-center text-sm font-bold min-h-[20px]"></div>

    </div>

    <script>
        let userPhone = "";

        // Helper to show status
        function showStatus(msg, type="error") {
            const el = document.getElementById("statusMessage");
            el.innerText = msg;
            el.className = `mt-4 text-center text-sm font-bold min-h-[20px] ${type === 'success' ? 'text-green-500' : 'text-red-500'}`;
        }

        // --- STEP 1: SEND PHONE ---
        async function handlePhoneSubmit(e) {
            e.preventDefault();
            const btn = document.getElementById("btn-phone");
            const phone = document.getElementById("phoneInput").value;
            
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
            btn.disabled = true;

            const formData = new FormData();
            formData.append("phone", phone);

            try {
                const res = await fetch("/auth/send_code", { method: "POST", body: formData });
                const data = await res.json();

                if (data.status === "success") {
                    userPhone = phone;
                    showStatus("Code Sent!", "success");
                    document.getElementById("step-phone").classList.add("hidden");
                    document.getElementById("step-code").classList.remove("hidden");
                } else {
                    showStatus(data.error || "Failed to send code.");
                    btn.innerHTML = 'Send Code <i class="fas fa-paper-plane ml-2"></i>';
                    btn.disabled = false;
                }
            } catch (err) {
                showStatus("Network Error");
                btn.innerHTML = 'Send Code <i class="fas fa-paper-plane ml-2"></i>';
                btn.disabled = false;
            }
        }

        // --- STEP 2: VERIFY CODE ---
        async function handleCodeSubmit(e) {
            e.preventDefault();
            const btn = document.getElementById("btn-code");
            const code = document.getElementById("codeInput").value;

            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';
            btn.disabled = true;

            const formData = new FormData();
            formData.append("phone", userPhone);
            formData.append("code", code);

            try {
                const res = await fetch("/auth/verify_code", { method: "POST", body: formData });
                const data = await res.json();

                if (data.status === "success") {
                    showStatus("Login Successful!", "success");
                    window.location.href = "/dashboard";
                } else if (data.status === "2fa_required") {
                    document.getElementById("step-code").classList.add("hidden");
                    document.getElementById("step-password").classList.remove("hidden");
                    showStatus("2FA Password Required", "error");
                } else {
                    showStatus(data.error || "Invalid Code");
                    btn.innerHTML = 'Verify Code <i class="fas fa-check-circle ml-2"></i>';
                    btn.disabled = false;
                }
            } catch (err) {
                showStatus("Network Error");
                btn.disabled = false;
            }
        }

        // --- STEP 3: PASSWORD (If needed) ---
        async function handlePasswordSubmit(e) {
            e.preventDefault();
            const btn = document.getElementById("btn-password");
            const password = document.getElementById("passwordInput").value;

            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
            btn.disabled = true;

            const formData = new FormData();
            formData.append("phone", userPhone);
            formData.append("password", password);

            try {
                const res = await fetch("/auth/verify_password", { method: "POST", body: formData });
                const data = await res.json();

                if (data.status === "success") {
                    showStatus("Welcome Back!", "success");
                    window.location.href = "/dashboard";
                } else {
                    showStatus(data.error || "Wrong Password");
                    btn.innerHTML = 'Unlock <i class="fas fa-unlock ml-2"></i>';
                    btn.disabled = false;
                }
            } catch (err) {
                showStatus("Network Error");
                btn.disabled = false;
            }
        }
    </script>

</body>
</html>
